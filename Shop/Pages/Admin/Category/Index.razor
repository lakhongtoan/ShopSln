@page "/admin/categories"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Shop.Models
@using Microsoft.EntityFrameworkCore

@inject AppDbContext Db
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider


<h4>Quản lý Danh mục</h4>
@if (categories == null)
{
    <p><em>Đang tải...</em></p>
}
else
{
    @if (!string.IsNullOrEmpty(deleteError))
    {
        <div class="alert alert-danger">@deleteError</div>
    }
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Tên danh mục</th>
                <th>Người tạo</th>
                <th>Ngày tạo</th>
                <th>Người cập nhật</th>
                <th>Ngày cập nhật</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var c in categories)
            {
                <tr>
                    <td>@c.CategoryId</td>
                    <td>@c.Name</td>
                    <td>@c.CreatedBy</td>
                    <td>@c.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@c.UpdatedBy</td>
                    <td>@c.UpdatedAt?.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>
                        <button class="btn btn-sm @(c.IsActive ? "btn-success" : "btn-secondary")"
                                @onclick="async () => await ToggleCategoryStatus(c)">
                            @(c.IsActive ? "Kích hoạt" : "Ẩn")
                        </button>
                    </td>
                    <td>
                        <NavLink class="btn btn-warning btn-sm me-2" href="@($"/admin/categories/edit/{c.CategoryId}")">
                            <i class="fa-solid fa-pen"></i> Sửa
                        </NavLink>
                        <button class="btn btn-danger btn-sm" @onclick="async () => await DeleteCategory(c)">
                            <i class="fa-solid fa-trash"></i> Xóa
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <NavLink class="btn btn-primary" href="/admin/categories/create">
        <i class="fa-solid fa-plus"></i> Thêm danh mục
    </NavLink>
}
@code {
    private List<Category> categories = new();
    private string? deleteError;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        categories = await Db.Categories.ToListAsync();
    }

    private async Task ToggleCategoryStatus(Category category)
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // Đảo ngược trạng thái
        category.IsActive = !category.IsActive;
        category.UpdatedAt = DateTime.Now;
        category.UpdatedBy = user.Identity?.Name ?? "Anonymous";

        Db.Categories.Update(category);
        await Db.SaveChangesAsync();

        await LoadData();
    }

    private async Task DeleteCategory(Category category)
    {
        // Kiểm tra xem còn Product nào dùng Category này không
        bool hasProducts = await Db.Products.AnyAsync(p => p.CategoryId == category.CategoryId);
        if (hasProducts)
        {
            deleteError = $"Danh mục '{category.Name}' vẫn còn sản phẩm đang sử dụng, không thể xóa!";
            return;
        }

        Db.Categories.Remove(category);
        await Db.SaveChangesAsync();
        await LoadData();
        deleteError = null;
    }
}
