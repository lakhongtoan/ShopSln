@page "/admin/categories/create"
@page "/admin/categories/edit/{id:int}"
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components.Authorization
@using Shop.Models
@using Microsoft.EntityFrameworkCore

@inject AppDbContext Db
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<h4>@(IsEdit ? "Chỉnh sửa danh mục" : "Thêm danh mục mới")</h4>

@if (Category == null)
{
    <p><em>Đang tải...</em></p>
}
else
{
    <EditForm Model="Category" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Tên danh mục</label>
            <InputText class="form-control" @bind-Value="Category.Name" />
        </div>

        <div class="form-check mb-3">
            <InputCheckbox class="form-check-input" @bind-Value="Category.IsActive" />
            <label class="form-check-label">Kích hoạt</label>
        </div>

        <button type="submit" class="btn btn-primary">
            💾 @(IsEdit ? "Cập nhật" : "Lưu")
        </button>

        <NavLink class="btn btn-secondary ms-2" href="/admin/categories">
            Quay lại
        </NavLink>
    </EditForm>
}

@code {
    [Parameter] public int? id { get; set; }
    private bool IsEdit => id.HasValue;
    private Category? Category;

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit)
        {
            // Dùng AsNoTracking để tránh tracking issues
            var existing = await Db.Categories
                .AsNoTracking()
                .FirstOrDefaultAsync(c => c.CategoryId == id);

            if (existing != null)
            {
                // Tạo bản copy mới
                Category = new Category
                {
                    CategoryId = existing.CategoryId,
                    Name = existing.Name,
                    IsActive = existing.IsActive,
                    CreatedAt = existing.CreatedAt,
                    CreatedBy = existing.CreatedBy,
                    UpdatedAt = existing.UpdatedAt,
                    UpdatedBy = existing.UpdatedBy
                };
            }
            else
            {
                // Không tìm thấy -> quay lại danh sách
                Nav.NavigateTo("/admin/categories");
            }
        }
        else
        {
            // Mode tạo mới
            Category = new Category
                {
                    IsActive = true
                };
        }
    }

    private async Task HandleSubmit()
    {
        if (Category == null) return;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userName = user.Identity?.Name ?? "Anonymous";

        if (IsEdit)
        {
            // Load lại entity từ DB và cập nhật từng field
            var existing = await Db.Categories.FindAsync(Category.CategoryId);
            if (existing != null)
            {
                existing.Name = Category.Name;
                existing.IsActive = Category.IsActive;
                existing.UpdatedAt = DateTime.Now;
                existing.UpdatedBy = userName;
                Db.Categories.Update(existing);
            }
            else
            {
                Nav.NavigateTo("/admin/categories");
                return;
            }
        }
        else
        {
            Category.CreatedAt = DateTime.Now;
            Category.CreatedBy = userName;
            Category.UpdatedAt = DateTime.Now;
            Category.UpdatedBy = userName;
            Db.Categories.Add(Category);
        }

        await Db.SaveChangesAsync();
        Nav.NavigateTo("/admin/categories");
    }
}
