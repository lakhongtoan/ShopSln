@page "/admin/categories/create"
@page "/admin/categories/edit/{id:int}"
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Shop.Models
@using Microsoft.EntityFrameworkCore

@inject AppDbContext Db
@inject NavigationManager Nav

<h4>@(IsEdit ? "Chỉnh sửa danh mục" : "Thêm danh mục mới")</h4>

@if (Category == null)
{
    <p><em>Đang tải...</em></p>
}
else
{
    <EditForm Model="Category" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="mb-3">
            <label class="form-label">Tên danh mục</label>
            <InputText class="form-control" @bind-Value="Category.Name" />
        </div>

        <div class="form-check mb-3">
            <InputCheckbox class="form-check-input" @bind-Value="Category.IsActive" />
            <label class="form-check-label">Kích hoạt</label>
        </div>

        <button type="submit" class="btn btn-primary">
            💾 @(IsEdit ? "Cập nhật" : "Lưu")
        </button>

        <NavLink class="btn btn-secondary ms-2" href="/admin/categories">
            Quay lại
        </NavLink>
    </EditForm>
}

@code {
    [Parameter] public int? id { get; set; }
    private bool IsEdit => id.HasValue;
    private Category? Category;

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit)
        {
            Category = await Db.Categories
                .FirstOrDefaultAsync(c => c.CategoryId == id);

            // Không tìm thấy -> tạo mới
            if (Category == null)
                Category = new Category();
        }
        else
        {
            // Mode tạo mới
            Category = new Category
                {
                    IsActive = true
                };
        }
    }

    private async Task HandleSubmit()
    {
        if (Category == null) return;

        if (IsEdit)
        {
            Db.Categories.Update(Category);
        }
        else
        {
            Category.CreatedAt = DateTime.Now;
            Db.Categories.Add(Category);
        }

        await Db.SaveChangesAsync();
        Nav.NavigateTo("/admin/categories");
    }
}
