@page "/admin/campingtips/upsert/{Id:int}"
@using Shop.Models
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db
@inject NavigationManager Nav
@inject IWebHostEnvironment Env

<h3>@(IsNew ? "Th√™m kinh nghi·ªám c·∫Øm tr·∫°i" : "Ch·ªânh s·ª≠a kinh nghi·ªám c·∫Øm tr·∫°i")</h3>

<EditForm Model="tip" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Ti√™u ƒë·ªÅ</label>
        <InputText @bind-Value="tip.Title" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">N·ªôi dung</label>
        <InputTextArea @bind-Value="tip.Content" class="form-control" rows="6" />
    </div>

    <div class="mb-3">
        <label class="form-label">T√°c gi·∫£</label>
        <InputText @bind-Value="tip.Author" class="form-control" />
    </div>

    <!-- Upload ·∫£nh -->
    <div class="mb-3">
        <label class="form-label">·∫¢nh minh h·ªça</label>
        <InputFile OnChange="UploadImage" />
        <small class="form-text text-muted">
            Ch·ªçn ·∫£nh m·ªõi ƒë·ªÉ thay ƒë·ªïi (n·∫øu kh√¥ng ch·ªçn th√¨ gi·ªØ nguy√™n ·∫£nh c≈©).
        </small>

        @if (!string.IsNullOrEmpty(tip.Image))
        {
            <div class="mt-2">
                <img src="@tip.Image" style="max-width:200px; border-radius:6px;" />
            </div>
        }
    </div>

    <div class="form-check mb-3">
        <InputCheckbox @bind-Value="tip.IsPublished" class="form-check-input" />
        <label class="form-check-label">Xu·∫•t b·∫£n</label>
    </div>

    <button type="submit" class="btn btn-success me-2">L∆∞u</button>
    <button type="button" class="btn btn-secondary" @onclick="Back">H·ªßy</button>
</EditForm>

@code {
    [Parameter] public int Id { get; set; }

    private CampingTip tip = new();
    private bool IsNew => Id == 0;

    protected override async Task OnInitializedAsync()
    {
        if (IsNew)
        {
            tip = new CampingTip
            {
                CreatedAt = DateTime.Now,
                IsPublished = true
            };
        }
        else
        {
            // D√πng AsNoTracking ƒë·ªÉ tr√°nh tracking issues
            var dbTip = await Db.CampingTips.AsNoTracking().FirstOrDefaultAsync(t => t.Id == Id);
            if (dbTip != null)
            {
                // T·∫°o b·∫£n copy m·ªõi
                tip = new CampingTip
                {
                    Id = dbTip.Id,
                    Title = dbTip.Title,
                    Content = dbTip.Content,
                    Author = dbTip.Author,
                    Image = dbTip.Image,
                    CreatedAt = dbTip.CreatedAt,
                    UpdatedAt = dbTip.UpdatedAt,
                    IsPublished = dbTip.IsPublished
                };
            }
            else
            {
                Nav.NavigateTo("/admin/campingtips");
            }
        }
    }

    private IBrowserFile? uploadedFile;

    // üìå H√ÄM UPLOAD ·∫¢NH T·ª™ THI·∫æT B·ªä
    private void UploadImage(InputFileChangeEventArgs e)
    {
        uploadedFile = e.File;
    }

    private async Task HandleValidSubmit()
    {
        // Validation
        if (string.IsNullOrWhiteSpace(tip.Title))
        {
            return;
        }

        if (string.IsNullOrWhiteSpace(tip.Content))
        {
            return;
        }

        string? newImagePath = null;

        // Upload ·∫£nh n·∫øu c√≥
        if (uploadedFile != null)
        {
            // Validate file size (10MB)
            const long maxFileSize = 10_000_000;
            if (uploadedFile.Size > maxFileSize)
            {
                return;
            }

            // Validate file extension
            var ext = Path.GetExtension(uploadedFile.Name).ToLower();
            var allowed = new[] { ".jpg", ".jpeg", ".png", ".webp" };
            if (!allowed.Contains(ext))
            {
                return;
            }

            var fileName = Guid.NewGuid().ToString() + ext;

            var folder = Path.Combine(Env.WebRootPath, "images/camping");
            if (!Directory.Exists(folder))
                Directory.CreateDirectory(folder);

            var filePath = Path.Combine(folder, fileName);

            using (var stream = new FileStream(filePath, FileMode.Create))
            {
                await uploadedFile.OpenReadStream(maxFileSize).CopyToAsync(stream);
            }

            // L∆∞u ƒë∆∞·ªùng d·∫´n m·ªõi
            newImagePath = $"/images/camping/{fileName}";
        }

        if (IsNew)
        {
            tip.CreatedAt = DateTime.Now;
            if (newImagePath != null)
            {
                tip.Image = newImagePath;
            }
            Db.CampingTips.Add(tip);
        }
        else
        {
            // Load l·∫°i entity t·ª´ DB v√† c·∫≠p nh·∫≠t t·ª´ng field
            var existing = await Db.CampingTips.FindAsync(tip.Id);
            if (existing != null)
            {
                existing.Title = tip.Title;
                existing.Content = tip.Content;
                existing.Author = tip.Author;
                existing.IsPublished = tip.IsPublished;
                existing.UpdatedAt = DateTime.Now;
                
                // Ch·ªâ c·∫≠p nh·∫≠t ·∫£nh n·∫øu c√≥ ·∫£nh m·ªõi
                if (newImagePath != null)
                {
                    existing.Image = newImagePath;
                }
                
                Db.CampingTips.Update(existing);
            }
            else
            {
                Nav.NavigateTo("/admin/campingtips");
                return;
            }
        }

        await Db.SaveChangesAsync();
        Nav.NavigateTo("/admin/campingtips");
    }

    private void Back() => Nav.NavigateTo("/admin/campingtips");
}
