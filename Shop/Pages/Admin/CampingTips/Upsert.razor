@page "/admin/campingtips/upsert/{Id:int}"
@using Shop.Models
@inject AppDbContext Db
@inject NavigationManager Nav
@inject IWebHostEnvironment Env

<h3>@(IsNew ? "Th√™m kinh nghi·ªám c·∫Øm tr·∫°i" : "Ch·ªânh s·ª≠a kinh nghi·ªám c·∫Øm tr·∫°i")</h3>

<EditForm Model="tip" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Ti√™u ƒë·ªÅ</label>
        <InputText @bind-Value="tip.Title" class="form-control" />
    </div>

    <div class="mb-3">
        <label class="form-label">N·ªôi dung</label>
        <InputTextArea @bind-Value="tip.Content" class="form-control" rows="6" />
    </div>

    <div class="mb-3">
        <label class="form-label">T√°c gi·∫£</label>
        <InputText @bind-Value="tip.Author" class="form-control" />
    </div>

    <!-- Upload ·∫£nh -->
    <div class="mb-3">
        <label class="form-label">·∫¢nh minh h·ªça</label>
        <InputFile OnChange="UploadImage" />

        @if (!string.IsNullOrEmpty(tip.Image))
        {
            <div class="mt-2">
                <img src="@tip.Image" style="max-width:200px; border-radius:6px;" />
            </div>
        }
    </div>

    <div class="form-check mb-3">
        <InputCheckbox @bind-Value="tip.IsPublished" class="form-check-input" />
        <label class="form-check-label">Xu·∫•t b·∫£n</label>
    </div>

    <button type="submit" class="btn btn-success me-2">L∆∞u</button>
    <button type="button" class="btn btn-secondary" @onclick="Back">H·ªßy</button>
</EditForm>

@code {
    [Parameter] public int Id { get; set; }

    private CampingTip tip = new();
    private bool IsNew => Id == 0;

    protected override async Task OnInitializedAsync()
    {
        if (IsNew)
        {
            tip = new CampingTip
            {
                CreatedAt = DateTime.Now,
                IsPublished = true
            };
        }
        else
        {
            var dbTip = await Db.CampingTips.FindAsync(Id);
            if (dbTip != null)
            {
                tip = dbTip;
            }
            else
            {
                Nav.NavigateTo("/admin/campingtips");
            }
        }
    }

    // üìå H√ÄM UPLOAD ·∫¢NH T·ª™ THI·∫æT B·ªä
    private async Task UploadImage(InputFileChangeEventArgs e)
    {
        var file = e.File;

        var fileName = Guid.NewGuid().ToString() + Path.GetExtension(file.Name);

        var folder = Path.Combine(Env.WebRootPath, "images/camping");
        if (!Directory.Exists(folder))
            Directory.CreateDirectory(folder);

        var filePath = Path.Combine(folder, fileName);

        using (var stream = new FileStream(filePath, FileMode.Create))
        {
            await file.OpenReadStream().CopyToAsync(stream);
        }

        // L∆∞u ƒë∆∞·ªùng d·∫´n v√†o database
        tip.Image = $"/images/camping/{fileName}";
    }

    private async Task HandleValidSubmit()
    {
        if (IsNew)
            Db.CampingTips.Add(tip);
        else
            Db.CampingTips.Update(tip);

        await Db.SaveChangesAsync();
        Nav.NavigateTo("/admin/campingtips");
    }

    private void Back() => Nav.NavigateTo("/admin/campingtips");
}
