@page "/admin/reviews"
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.EntityFrameworkCore
@using Microsoft.JSInterop
@using Shop.Models
@implements IDisposable

@inject AppDbContext Db
@inject IJSRuntime JsRuntime
@inject NavigationManager Navigation

<h4 class="mb-4 fw-bold">Quản lý đánh giá sản phẩm</h4>

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @successMessage
        <button type="button" class="btn-close" @onclick="() => successMessage = null" aria-label="Close"></button>
    </div>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @errorMessage
        <button type="button" class="btn-close" @onclick="() => errorMessage = null" aria-label="Close"></button>
    </div>
}

@if (ReviewData == null)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Đang tải...</span>
        </div>
        <p class="mt-2 text-muted">Đang tải dữ liệu...</p>
    </div>
}
else
{
    <!-- Filter và tìm kiếm -->
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <label class="mb-0 fw-semibold">Đánh giá:</label>
            <InputSelect class="form-select" style="width: auto;" @bind-Value="selectedRating" @bind-Value:after="HandleRatingChange">
                <option value="">Tất cả</option>
                <option value="1">1 sao</option>
                <option value="2">2 sao</option>
                <option value="3">3 sao</option>
                <option value="4">4 sao</option>
                <option value="5">5 sao</option>
            </InputSelect>

            <label class="mb-0 fw-semibold ms-3">Trạng thái:</label>
            <InputSelect class="form-select" style="width: auto;" @bind-Value="selectedStatus" @bind-Value:after="HandleStatusChange">
                <option value="">Tất cả</option>
                <option value="true">Hoạt động</option>
                <option value="false">Đã ẩn</option>
            </InputSelect>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
            <label class="mb-0 fw-semibold">Sản phẩm:</label>
            <InputSelect class="form-select" style="width: 200px;" @bind-Value="selectedProductId" @bind-Value:after="HandleProductChange">
                <option value="">Tất cả sản phẩm</option>
                @if (ProductList != null)
                {
                    @foreach (var product in ProductList)
                    {
                        <option value="@product.ProductID">@product.Name</option>
                    }
                }
            </InputSelect>

            <label class="mb-0 fw-semibold">Tìm kiếm:</label>
            <InputText class="form-control" style="width: 300px;" 
                       placeholder="Tìm theo tên sản phẩm, người dùng..." 
                       @bind-Value="searchTerm" @bind-Value:after="HandleSearchInput" />
        </div>
    </div>

    <!-- Bảng đánh giá -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center" style="width: 60px;">ID</th>
                            <th style="width: 200px;">Sản phẩm</th>
                            <th style="width: 150px;">Người đánh giá</th>
                            <th class="text-center" style="width: 100px;">Đánh giá</th>
                            <th>Bình luận</th>
                            <th class="text-center" style="width: 150px;">Ngày đánh giá</th>
                            <th class="text-center" style="width: 100px;">Trạng thái</th>
                            <th class="text-center" style="width: 180px;">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!ReviewData.Any())
                        {
                            <tr>
                                <td colspan="8" class="text-center py-5 text-muted">
                                    <i class="fa-solid fa-comments fa-2x mb-2 d-block"></i>
                                    Không có đánh giá nào
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var review in ReviewData)
                            {
                                <tr class="@(!review.IsActive ? "table-secondary" : "")">
                                    <td class="text-center">@review.ReviewId</td>
                                    <td>
                                        @if (review.Product != null)
                                        {
                                            <div class="d-flex align-items-center">
                                                @if (!string.IsNullOrEmpty(review.Product.Image))
                                                {
                                                    <img src="@review.Product.Image" alt="@review.Product.Name" 
                                                         class="me-2 rounded" 
                                                         style="width: 50px; height: 50px; object-fit: cover;" />
                                                }
                                                <div>
                                                    <div class="fw-semibold">@review.Product.Name</div>
                                                    <small class="text-muted">ID: @review.ProductId</small>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Sản phẩm đã bị xóa</span>
                                        }
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="user-avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2" 
                                                 style="width: 35px; height: 35px; font-weight: bold; font-size: 0.9rem;">
                                                @((review.UserName ?? "N")[0].ToString().ToUpper())
                                            </div>
                                            <div>
                                                <div class="fw-semibold">@(review.UserName ?? "Người dùng")</div>
                                                <small class="text-muted">@review.UserId</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="star-rating">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <i class="fa @(i <= review.Rating ? "fa-star text-warning" : "fa-star-o text-muted")" style="font-size: 1rem;"></i>
                                            }
                                        </div>
                                        <small class="text-muted">@review.Rating/5</small>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(review.Comment))
                                        {
                                            <div class="text-truncate" style="max-width: 300px;" title="@review.Comment">
                                                @review.Comment
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted fst-italic">Không có bình luận</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <small>@review.CreatedAt.ToString("dd/MM/yyyy")</small>
                                        <br />
                                        <small class="text-muted">@review.CreatedAt.ToString("HH:mm")</small>
                                    </td>
                                    <td class="text-center">
                                        @if (review.IsActive)
                                        {
                                            <span class="badge bg-success">Hoạt động</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Đã ẩn</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm @(review.IsActive ? "btn-warning" : "btn-success")" 
                                                    @onclick="() => ToggleActive(review.ReviewId)"
                                                    title="@(review.IsActive ? "Ẩn đánh giá" : "Hiện đánh giá")">
                                                <i class="fa-solid fa-@(review.IsActive ? "eye-slash" : "eye")"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" 
                                                    @onclick="() => ConfirmDelete(review.ReviewId)"
                                                    title="Xóa đánh giá">
                                                <i class="fa-solid fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    @if (_totalPages > 1)
    {
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
                Hiển thị @((_pageNumber - 1) * _pageSize + 1) - @(Math.Min(_pageNumber * _pageSize, totalReviews)) trong tổng số @totalReviews đánh giá
            </div>
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item @(_pageNumber == 1 ? "disabled" : "")">
                        <button class="page-link" @onclick="PreviousPage" disabled="@(_pageNumber == 1)">« Trước</button>
                    </li>
                    @for (int i = Math.Max(1, _pageNumber - 2); i <= Math.Min(_totalPages, _pageNumber + 2); i++)
                    {
                        var pageNum = i;
                        <li class="page-item @(_pageNumber == pageNum ? "active" : "")">
                            <button class="page-link" @onclick="() => GoToPage(pageNum)">@pageNum</button>
                        </li>
                    }
                    <li class="page-item @(_pageNumber == _totalPages ? "disabled" : "")">
                        <button class="page-link" @onclick="NextPage" disabled="@(_pageNumber == _totalPages)">Tiếp »</button>
                    </li>
                </ul>
            </nav>
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
                Hiển thị @totalReviews đánh giá
            </div>
            <div class="text-muted">
                Trang @_pageNumber / @_totalPages
            </div>
        </div>
    }
}

@code {
    private List<ProductReview>? ReviewData;
    private List<Product>? ProductList;
    private int _pageNumber = 1;
    private int _pageSize = 15;
    private int _totalPages = 1;
    private string selectedRating = "";
    private string selectedStatus = "";
    private string searchTerm = "";
    private string? selectedProductId = "";
    private string? successMessage;
    private string? errorMessage;
    
    // Thống kê
    private int totalReviews = 0;
    private int activeCount = 0;
    private int inactiveCount = 0;
    private double averageRating = 0;

    // Semaphore để tránh concurrent database operations
    private readonly SemaphoreSlim _dbSemaphore = new SemaphoreSlim(1, 1);
    private bool _isLoading = false;

    // Dispose semaphore khi component bị dispose
    public void Dispose()
    {
        _dbSemaphore?.Dispose();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadProductList();
        await LoadData();
    }

    private async Task LoadProductList()
    {
        try
        {
            ProductList = await Db.Products
                .AsNoTracking()
                .Where(p => p.IsActive)
                .OrderBy(p => p.Name)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải danh sách sản phẩm: {ex.Message}";
            ProductList = new List<Product>();
        }
    }

    private async Task LoadData()
    {
        if (_isLoading) return;
        
        await _dbSemaphore.WaitAsync();
        try
        {
            _isLoading = true;
            await LoadPage();
            await LoadStatistics();
        }
        finally
        {
            _isLoading = false;
            _dbSemaphore.Release();
        }
    }

    private async Task LoadStatistics()
    {
        try
        {
            var allReviews = await Db.ProductReviews.AsNoTracking().ToListAsync();
            
            totalReviews = allReviews.Count;
            activeCount = allReviews.Count(r => r.IsActive);
            inactiveCount = allReviews.Count(r => !r.IsActive);
            averageRating = allReviews.Any() ? allReviews.Average(r => r.Rating) : 0;
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải thống kê: {ex.Message}";
        }
    }

    private async Task LoadPage()
    {
        try
        {
            var query = Db.ProductReviews
                .Include(r => r.Product)
                .AsQueryable();

            // Lọc theo đánh giá
            if (!string.IsNullOrEmpty(selectedRating) && int.TryParse(selectedRating, out int rating))
            {
                query = query.Where(r => r.Rating == rating);
            }

            // Lọc theo trạng thái
            if (!string.IsNullOrEmpty(selectedStatus) && bool.TryParse(selectedStatus, out bool isActive))
            {
                query = query.Where(r => r.IsActive == isActive);
            }

            // Lọc theo sản phẩm
            if (!string.IsNullOrEmpty(selectedProductId) && long.TryParse(selectedProductId, out long productId))
            {
                query = query.Where(r => r.ProductId == productId);
            }

            // Tìm kiếm
            if (!string.IsNullOrEmpty(searchTerm))
            {
                var search = searchTerm.ToLower();
                query = query.Where(r => 
                    (r.Product != null && r.Product.Name.ToLower().Contains(search)) ||
                    (r.UserName != null && r.UserName.ToLower().Contains(search)) ||
                    (r.UserId != null && r.UserId.ToLower().Contains(search)) ||
                    (r.Comment != null && r.Comment.ToLower().Contains(search)));
            }

            var total = await query.CountAsync();
            _totalPages = (int)Math.Ceiling(total / (double)_pageSize);
            if (_totalPages == 0) _totalPages = 1;

            ReviewData = await query
                .OrderByDescending(r => r.CreatedAt)
                .Skip((_pageNumber - 1) * _pageSize)
                .Take(_pageSize)
                .AsNoTracking()
                .ToListAsync();

            totalReviews = total;
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải dữ liệu: {ex.Message}";
            ReviewData = new List<ProductReview>();
        }
    }

    private async Task HandleRatingChange()
    {
        _pageNumber = 1;
        await LoadData();
    }

    private async Task HandleStatusChange()
    {
        _pageNumber = 1;
        await LoadData();
    }

    private async Task HandleSearchInput()
    {
        _pageNumber = 1;
        await LoadData();
    }

    private async Task HandleProductChange()
    {
        _pageNumber = 1;
        await LoadData();
    }

    private async Task NextPage()
    {
        if (_pageNumber < _totalPages)
        {
            _pageNumber++;
            await LoadData();
        }
    }

    private async Task PreviousPage()
    {
        if (_pageNumber > 1)
        {
            _pageNumber--;
            await LoadData();
        }
    }

    private async Task GoToPage(int page)
    {
        if (page >= 1 && page <= _totalPages)
        {
            _pageNumber = page;
            await LoadData();
        }
    }

    private async Task ToggleActive(int reviewId)
    {
        try
        {
            var review = await Db.ProductReviews.FirstOrDefaultAsync(r => r.ReviewId == reviewId);
            if (review == null)
            {
                errorMessage = "Không tìm thấy đánh giá!";
                return;
            }

            review.IsActive = !review.IsActive;
            await Db.SaveChangesAsync();
            
            successMessage = review.IsActive ? "Đánh giá đã được hiển thị!" : "Đánh giá đã được ẩn!";
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi cập nhật: {ex.Message}";
        }
    }

    private async Task ConfirmDelete(int reviewId)
    {
        var confirmed = await JsRuntime.InvokeAsync<bool>("eval", "confirm('Bạn có chắc chắn muốn xóa đánh giá này? Hành động này không thể hoàn tác!')");
        
        if (confirmed)
        {
            await DeleteReview(reviewId);
        }
    }

    private async Task DeleteReview(int reviewId)
    {
        try
        {
            var review = await Db.ProductReviews.FirstOrDefaultAsync(r => r.ReviewId == reviewId);

            if (review == null)
            {
                errorMessage = "Không tìm thấy đánh giá!";
                return;
            }

            Db.ProductReviews.Remove(review);
            await Db.SaveChangesAsync();
            successMessage = "Xóa đánh giá thành công!";
            
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi xóa đánh giá: {ex.Message}";
        }
    }
}

<style>
.user-avatar {
    flex-shrink: 0;
}

.star-rating {
    white-space: nowrap;
}

.table-secondary {
    opacity: 0.7;
}
</style>

