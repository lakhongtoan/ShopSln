@page "/admin/orders/details/{id:int}"
@using Microsoft.EntityFrameworkCore
@using Shop.Models

@inject AppDbContext Db
@inject NavigationManager Nav

<h4>Chi ti·∫øt ƒë∆°n h√†ng</h4>

@if (order == null)
{
    <p><em>ƒêang t·∫£i th√¥ng tin ƒë∆°n h√†ng...</em></p>
}
else
{
    <div class="row">
        <!-- C·ªôt tr√°i -->
        <div class="col-md-8">
            <!-- Th√¥ng tin ƒë∆°n h√†ng -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Th√¥ng tin ƒë∆°n h√†ng</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>M√£ ƒë∆°n h√†ng:</strong></div>
                        <div class="col-md-8">@order.OrderNumber</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Ng√†y ƒë·∫∑t h√†ng:</strong></div>
                        <div class="col-md-8">@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Tr·∫°ng th√°i:</strong></div>
                        <div class="col-md-8">
                            <span class="badge @GetStatusBadgeClass(order.Status)">
                                @GetStatusText(order.Status)
                            </span>
                        </div>
                    </div>
                    @if (order.ShippedDate.HasValue)
                    {
                        <div class="row mb-2">
                            <div class="col-md-4"><strong>Ng√†y giao h√†ng:</strong></div>
                            <div class="col-md-8">@order.ShippedDate.Value.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                    }
                    @if (order.DeliveredDate.HasValue)
                    {
                        <div class="row mb-2">
                            <div class="col-md-4"><strong>Ng√†y nh·∫≠n h√†ng:</strong></div>
                            <div class="col-md-8">@order.DeliveredDate.Value.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(order.Notes))
                    {
                        <div class="row mb-2">
                            <div class="col-md-4"><strong>Ghi ch√∫:</strong></div>
                            <div class="col-md-8">@order.Notes</div>
                        </div>
                    }
                </div>
            </div>

            <!-- Th√¥ng tin kh√°ch h√†ng -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Th√¥ng tin kh√°ch h√†ng</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>H·ªç t√™n:</strong></div>
                        <div class="col-md-8">@order.CustomerName</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Email:</strong></div>
                        <div class="col-md-8">@order.CustomerEmail</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>S·ªë ƒëi·ªán tho·∫°i:</strong></div>
                        <div class="col-md-8">@order.CustomerPhone</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong></div>
                        <div class="col-md-8">@order.ShippingAddress</div>
                    </div>
                    @if (!string.IsNullOrEmpty(order.BillingAddress))
                    {
                        <div class="row mb-2">
                            <div class="col-md-4"><strong>ƒê·ªãa ch·ªâ thanh to√°n:</strong></div>
                            <div class="col-md-8">@order.BillingAddress</div>
                        </div>
                    }
                </div>
            </div>

            <!-- Chi ti·∫øt s·∫£n ph·∫©m -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Chi ti·∫øt s·∫£n ph·∫©m</h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>H√¨nh ·∫£nh</th>
                                <th>T√™n s·∫£n ph·∫©m</th>
                                <th>ƒê∆°n gi√°</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in orderItems)
                            {
                                <tr>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.ProductImage))
                                        {
                                            <img src="@item.ProductImage" alt="@item.ProductName" style="max-width:80px; max-height:80px;" />
                                        }
                                    </td>
                                    <td>@item.ProductName</td>
                                    <td>@string.Format("{0:N0} ‚Ç´", item.UnitPrice)</td>
                                    <td>@item.Quantity</td>
                                    <td>@string.Format("{0:N0} ‚Ç´", item.TotalPrice)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- C·ªôt ph·∫£i -->
        <div class="col-md-4">
            <!-- T·ªïng ti·ªÅn -->
            <div class="card mb-3">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">T·ªïng thanh to√°n</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>T·∫°m t√≠nh:</span>
                        <strong>@string.Format("{0:N0} ‚Ç´", order.SubTotal)</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Thu·∫ø:</span>
                        <strong>@string.Format("{0:N0} ‚Ç´", order.TaxAmount)</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
                        <strong>@string.Format("{0:N0} ‚Ç´", order.ShippingAmount)</strong>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between">
                        <span><strong>T·ªïng c·ªông:</strong></span>
                        <strong class="text-danger fs-5">@string.Format("{0:N0} ‚Ç´", order.TotalAmount)</strong>
                    </div>
                </div>
            </div>

            <!-- Form c·∫≠p nh·∫≠t tr·∫°ng th√°i -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">C·∫≠p nh·∫≠t tr·∫°ng th√°i</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="order" OnValidSubmit="HandleUpdateStatus">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <div class="mb-3">
                            <label class="form-label">Tr·∫°ng th√°i ƒë∆°n h√†ng</label>
                            <InputSelect class="form-select" @bind-Value="order.Status">
                                <option value="Pending">Ch·ªù x·ª≠ l√Ω</option>
                                <option value="Processing">ƒêang x·ª≠ l√Ω</option>
                                <option value="Shipped">ƒê√£ giao h√†ng</option>
                                <option value="Delivered">ƒê√£ nh·∫≠n h√†ng</option>
                                <option value="Cancelled">ƒê√£ h·ªßy</option>
                            </InputSelect>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ghi ch√∫</label>
                            <InputTextArea class="form-control" @bind-Value="order.Notes" Rows="3" />
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" type="submit">C·∫≠p nh·∫≠t tr·∫°ng th√°i</button>
                            <NavLink class="btn btn-secondary" href="/admin/orders">Quay l·∫°i danh s√°ch</NavLink>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }
    private Order? order;
    private List<OrderItem> orderItems = new();

    protected override async Task OnInitializedAsync()
    {
        // üëâ Load ƒë·∫ßy ƒë·ªß c·∫£ Order + OrderItems trong 1 query ƒë·ªÉ tr√°nh null
        order = await Db.Orders
            .Include(o => o.OrderItems)
            .FirstOrDefaultAsync(o => o.OrderId == id);

        if (order != null)
            orderItems = order.OrderItems.ToList();
    }

    private async Task HandleUpdateStatus()
    {
        if (order == null) return;

        // üëâ Logic t·ª± ƒë·ªông set ng√†y
        if (order.Status == "Shipped" && !order.ShippedDate.HasValue)
            order.ShippedDate = DateTime.Now;
        else if (order.Status == "Delivered" && !order.DeliveredDate.HasValue)
        {
            order.DeliveredDate = DateTime.Now;
            if (!order.ShippedDate.HasValue)
                order.ShippedDate = DateTime.Now;
        }

        Db.Orders.Update(order);
        await Db.SaveChangesAsync();

        // üëâ Sau khi c·∫≠p nh·∫≠t, quay l·∫°i danh s√°ch ƒë∆°n h√†ng
        Nav.NavigateTo("/admin/orders");
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Pending" => "bg-warning",
        "Processing" => "bg-info",
        "Shipped" => "bg-primary",
        "Delivered" => "bg-success",
        "Cancelled" => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusText(string status) => status switch
    {
        "Pending" => "Ch·ªù x·ª≠ l√Ω",
        "Processing" => "ƒêang x·ª≠ l√Ω",
        "Shipped" => "ƒê√£ giao h√†ng",
        "Delivered" => "ƒê√£ nh·∫≠n h√†ng",
        "Cancelled" => "ƒê√£ h·ªßy",
        _ => status
    };
}
