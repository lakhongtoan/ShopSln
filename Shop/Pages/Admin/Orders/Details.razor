@page "/admin/orders/details/{id:int}"
@using Microsoft.EntityFrameworkCore
@using Shop.Models

@inject AppDbContext Db
@inject NavigationManager Nav

<h4>Chi tiết đơn hàng</h4>

@if (order == null)
{
    <p><em>Đang tải thông tin đơn hàng...</em></p>
}
else
{
    <div class="row">
        <!-- Cột trái -->
        <div class="col-md-8">
            <!-- Thông tin đơn hàng -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Thông tin đơn hàng</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Mã đơn hàng:</strong></div>
                        <div class="col-md-8">@order.OrderNumber</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Ngày đặt hàng:</strong></div>
                        <div class="col-md-8">@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Trạng thái:</strong></div>
                        <div class="col-md-8">
                            <span class="badge @GetStatusBadgeClass(order.Status)">
                                @GetStatusText(order.Status)
                            </span>
                        </div>
                    </div>
                    @if (order.ShippedDate.HasValue)
                    {
                        <div class="row mb-2">
                            <div class="col-md-4"><strong>Ngày giao hàng:</strong></div>
                            <div class="col-md-8">@order.ShippedDate.Value.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                    }
                    @if (order.DeliveredDate.HasValue)
                    {
                        <div class="row mb-2">
                            <div class="col-md-4"><strong>Ngày nhận hàng:</strong></div>
                            <div class="col-md-8">@order.DeliveredDate.Value.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(order.Notes))
                    {
                        <div class="row mb-2">
                            <div class="col-md-4"><strong>Ghi chú:</strong></div>
                            <div class="col-md-8">@order.Notes</div>
                        </div>
                    }
                </div>
            </div>

            <!-- Thông tin khách hàng -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Thông tin khách hàng</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Họ tên:</strong></div>
                        <div class="col-md-8">@order.CustomerName</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Email:</strong></div>
                        <div class="col-md-8">@order.CustomerEmail</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Số điện thoại:</strong></div>
                        <div class="col-md-8">@order.CustomerPhone</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-4"><strong>Địa chỉ giao hàng:</strong></div>
                        <div class="col-md-8">@order.ShippingAddress</div>
                    </div>
                    @if (!string.IsNullOrEmpty(order.BillingAddress))
                    {
                        <div class="row mb-2">
                            <div class="col-md-4"><strong>Địa chỉ thanh toán:</strong></div>
                            <div class="col-md-8">@order.BillingAddress</div>
                        </div>
                    }
                </div>
            </div>

            <!-- Chi tiết sản phẩm -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">Chi tiết sản phẩm</h5>
                </div>
                <div class="card-body">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Hình ảnh</th>
                                <th>Tên sản phẩm</th>
                                <th>Đơn giá</th>
                                <th>Số lượng</th>
                                <th>Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in orderItems)
                            {
                                <tr>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.ProductImage))
                                        {
                                            <img src="@item.ProductImage" alt="@item.ProductName" style="max-width:80px; max-height:80px;" />
                                        }
                                    </td>
                                    <td>@item.ProductName</td>
                                    <td>@string.Format("{0:N0} ₫", item.UnitPrice)</td>
                                    <td>@item.Quantity</td>
                                    <td>@string.Format("{0:N0} ₫", item.TotalPrice)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cột phải -->
        <div class="col-md-4">
            <!-- Tổng tiền -->
            <div class="card mb-3">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Tổng thanh toán</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tạm tính:</span>
                        <strong>@string.Format("{0:N0} ₫", order.SubTotal)</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Thuế:</span>
                        <strong>@string.Format("{0:N0} ₫", order.TaxAmount)</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Phí vận chuyển:</span>
                        <strong>@string.Format("{0:N0} ₫", order.ShippingAmount)</strong>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between">
                        <span><strong>Tổng cộng:</strong></span>
                        <strong class="text-danger fs-5">@string.Format("{0:N0} ₫", order.TotalAmount)</strong>
                    </div>
                </div>
            </div>

            <!-- Form cập nhật trạng thái -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Cập nhật trạng thái</h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(updateMessage))
                    {
                        <div class="alert @(updateMessage.Contains("thành công") ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
                            @updateMessage
                            <button type="button" class="btn-close" @onclick="() => updateMessage = null" aria-label="Close"></button>
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">Trạng thái đơn hàng</label>
                        <select class="form-select" @bind="selectedStatus">
                            <option value="Pending">Chờ xử lý</option>
                            <option value="Processing">Đang xử lý</option>
                            <option value="Shipped">Đã giao hàng</option>
                            <option value="Delivered">Đã nhận hàng</option>
                            <option value="Cancelled">Đã hủy</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ghi chú</label>
                        <textarea class="form-control" rows="3" @bind="orderNotes"></textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" @onclick="HandleUpdateStatus" disabled="@isUpdating">
                            @if (isUpdating)
                            {
                                <span>Đang cập nhật...</span>
                            }
                            else
                            {
                                <span>Cập nhật trạng thái</span>
                            }
                        </button>
                        <NavLink class="btn btn-secondary" href="/admin/orders">Quay lại danh sách</NavLink>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int id { get; set; }
    private Order? order;
    private List<OrderItem> orderItems = new();
    private string? updateMessage = null;
    private bool isUpdating = false;
    private int lastLoadedId = 0; // Track id đã load để tránh reload không cần thiết
    
    // Form fields - tách biệt với entity để tránh tracking issues
    private string selectedStatus = "Pending";
    private string orderNotes = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadOrderData();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Chỉ reload khi id thay đổi
        if (id > 0 && id != lastLoadedId)
        {
            await LoadOrderData();
        }
    }

    private async Task LoadOrderData()
    {
        try
        {
            // Load với AsNoTracking để tránh tracking conflict
            var loadedOrder = await Db.Orders
                .Include(o => o.OrderItems)
                .AsNoTracking()
                .FirstOrDefaultAsync(o => o.OrderId == id);

            if (loadedOrder != null)
            {
                // Tạo instance mới để hiển thị (không tracked)
                order = new Order
                {
                    OrderId = loadedOrder.OrderId,
                    OrderNumber = loadedOrder.OrderNumber,
                    OrderDate = loadedOrder.OrderDate,
                    Status = loadedOrder.Status,
                    SubTotal = loadedOrder.SubTotal,
                    TaxAmount = loadedOrder.TaxAmount,
                    ShippingAmount = loadedOrder.ShippingAmount,
                    TotalAmount = loadedOrder.TotalAmount,
                    CustomerName = loadedOrder.CustomerName,
                    CustomerPhone = loadedOrder.CustomerPhone,
                    CustomerEmail = loadedOrder.CustomerEmail,
                    ShippingAddress = loadedOrder.ShippingAddress,
                    BillingAddress = loadedOrder.BillingAddress,
                    ShippedDate = loadedOrder.ShippedDate,
                    DeliveredDate = loadedOrder.DeliveredDate,
                    Notes = loadedOrder.Notes
                };
                
                // Copy OrderItems
                orderItems = loadedOrder.OrderItems?.ToList() ?? new List<OrderItem>();
                
                // Cập nhật form fields
                selectedStatus = order.Status;
                orderNotes = order.Notes ?? "";
                
                // Lưu id đã load
                lastLoadedId = id;
            }
            else
            {
                order = null;
                orderItems = new List<OrderItem>();
            }
        }
        catch (Exception ex)
        {
            updateMessage = $"Lỗi khi tải dữ liệu: {ex.Message}";
            order = null;
            orderItems = new List<OrderItem>();
        }
    }

    private async Task HandleUpdateStatus()
    {
        if (order == null) return;

        isUpdating = true;
        updateMessage = null;

        try
        {
            // Load entity mới từ database (có tracking) để update
            var orderToUpdate = await Db.Orders
                .FirstOrDefaultAsync(o => o.OrderId == id);

            if (orderToUpdate == null)
            {
                updateMessage = "Không tìm thấy đơn hàng!";
                isUpdating = false;
                return;
            }

            // Cập nhật trạng thái và ghi chú từ form
            orderToUpdate.Status = selectedStatus;
            orderToUpdate.Notes = orderNotes;

            // Logic tự động set ngày khi chuyển sang trạng thái tương ứng
            if (selectedStatus == "Shipped")
            {
                // Cập nhật ngày giao hàng mỗi khi chuyển về trạng thái Shipped
                orderToUpdate.ShippedDate = DateTime.Now;
            }
            else if (selectedStatus == "Delivered")
            {
                // Cập nhật ngày nhận hàng mỗi khi chuyển về trạng thái Delivered
                orderToUpdate.DeliveredDate = DateTime.Now;
                // Đảm bảo có ngày giao hàng nếu chưa có
                if (!orderToUpdate.ShippedDate.HasValue)
                    orderToUpdate.ShippedDate = DateTime.Now;
            }

            // Lưu thay đổi
            await Db.SaveChangesAsync();

            // Reload lại dữ liệu để hiển thị thông tin mới nhất
            await LoadOrderData();
            
            updateMessage = "Cập nhật trạng thái thành công!";
        }
        catch (Exception ex)
        {
            updateMessage = $"Lỗi khi cập nhật: {ex.Message}";
        }
        finally
        {
            isUpdating = false;
        }
    }

    private string GetStatusBadgeClass(string status) => status switch
    {
        "Pending" => "bg-warning",
        "Processing" => "bg-info",
        "Shipped" => "bg-primary",
        "Delivered" => "bg-success",
        "Cancelled" => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetStatusText(string status) => status switch
    {
        "Pending" => "Chờ xử lý",
        "Processing" => "Đang xử lý",
        "Shipped" => "Đã giao hàng",
        "Delivered" => "Đã nhận hàng",
        "Cancelled" => "Đã hủy",
        _ => status
    };
}
