@page "/admin"
@layout AdminLayout

@using System.Globalization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@inject AppDbContext Db

<h4>WellCome</h4>

<div class="row gy-3">
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card bg-white p-3 h-100 border-0 shadow-sm">
            <h6 class="text-muted">TỔNG SẢN PHẨM</h6>
            <h4 class="fw-bold text-success">@TotalProducts</h4>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card bg-white p-3 h-100 border-0 shadow-sm">
            <h6 class="text-muted">TỔNG ĐƠN HÀNG</h6>
            <h4 class="fw-bold text-primary">@TotalOrders</h4>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card bg-white p-3 h-100 border-0 shadow-sm">
            <h6 class="text-muted">DANH MỤC</h6>
            <h4 class="fw-bold text-warning">@TotalCategories</h4>
        </div>
    </div>
    <div class="col-12 col-sm-6 col-lg-3">
        <div class="card bg-white p-3 h-100 border-0 shadow-sm">
            <h6 class="text-muted">LIÊN HỆ</h6>
            <h4 class="fw-bold text-danger">@TotalContacts</h4>
        </div>
    </div>
</div>

<h4 class="mt-5 fw-bold">Đơn hàng gần đây</h4>

@if (RecentOrders == null)
{
    <p><em>Đang tải...</em></p>
}
else if (!RecentOrders.Any())
{
    <p>Không có đơn hàng chờ xử lý.</p>
}
else
{
    <table class="table table-bordered table-hover text-center">
        <thead class="table-success">
            <tr>
                <th>Mã đơn</th>
                <th>Khách hàng</th>
                <th>Email</th>
                <th>Số điện thoại</th>
                <th>Ngày đặt</th>
                <th>Tổng tiền</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in RecentOrders)
            {
                <tr>
                    <td>@order.OrderNumber</td>
                    <td>@order.CustomerName</td>
                    <td>@order.CustomerEmail</td>
                    <td>@order.CustomerPhone</td>
                    <td>@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@string.Format("{0:N0} ₫", order.TotalAmount)</td>
                    <td>
                        <span class="badge bg-warning">@GetStatusText(order.Status)</span>
                    </td>
                    <td>
                        <NavLink class="btn btn-info btn-sm" href="@($"/admin/orders/details/{order.OrderId}")">
                            <i class="fa-solid fa-eye"></i> Chi tiết
                        </NavLink>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private int TotalProducts;
    private int TotalOrders;
    private int TotalCategories;
    private int TotalContacts;
    private List<Order>? RecentOrders;

    protected override async Task OnInitializedAsync()
    {
        TotalProducts = await Db.Products.CountAsync();
        TotalOrders = await Db.Orders.CountAsync();
        TotalCategories = await Db.Categories.CountAsync();
        TotalContacts = await Db.Contacts.CountAsync();

        // Lấy 10 đơn hàng gần đây đang Pending
        RecentOrders = await Db.Orders
            .Where(o => o.Status == "Pending")
            .OrderByDescending(o => o.OrderDate)
            .Take(10)
            .ToListAsync();
    }

    private string GetStatusText(string status) => status switch
    {
        "Pending" => "Chờ xử lý",
        "Processing" => "Đang xử lý",
        "Shipped" => "Đã giao hàng",
        "Delivered" => "Đã nhận hàng",
        "Cancelled" => "Đã hủy",
        _ => status
    };
}
