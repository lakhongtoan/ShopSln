@page "/admin/sliders/create"
@page "/admin/sliders/edit/{Id:int}"

@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.EntityFrameworkCore
@using Shop.Models

@inject AppDbContext Db
@inject NavigationManager Nav
@inject AuthenticationStateProvider Auth
@inject IWebHostEnvironment Env

<h3 class="text-center p-2 rounded">@TitleText Slider</h3>

<EditForm Model="Slider" OnValidSubmit="SaveSlider">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="form-group mb-3">
        <label>Tiêu đề</label>
        <InputText class="form-control" @bind-Value="Slider.Title" />
    </div>

    <div class="form-group mb-3">
        <label>Ảnh Slider</label>
        <InputFile OnChange="HandleFileSelected" />
        @if (!string.IsNullOrEmpty(Slider.Image))
        {
            <div class="mt-2">
                <img src="@Slider.Image" style="max-height:100px; border-radius:6px;" />
            </div>
        }
        @if (!string.IsNullOrEmpty(UploadError))
        {
            <div class="text-danger mt-1">@UploadError</div>
        }
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-@ThemeColor">Lưu</button>
        <NavLink class="btn btn-secondary ms-2" href="/admin/sliders">Hủy</NavLink>
    </div>
</EditForm>

@code {
    [Parameter] public int Id { get; set; }
    private Slider Slider { get; set; } = new();
    private IBrowserFile? SelectedFile;
    private string? UploadError;

    private bool IsEdit => Id != 0;
    private string TitleText => IsEdit ? "Chỉnh sửa" : "Thêm";
    private string ThemeColor => IsEdit ? "warning" : "primary";

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit)
        {
            // Dùng AsNoTracking để tránh tracking issues
            var existing = await Db.Sliders.AsNoTracking().FirstOrDefaultAsync(s => s.SliderID == Id);
            if (existing != null)
            {
                // Tạo bản copy mới
                Slider = new Slider
                {
                    SliderID = existing.SliderID,
                    Title = existing.Title,
                    Image = existing.Image,
                    CreatedAt = existing.CreatedAt,
                    CreatedBy = existing.CreatedBy,
                    UpdatedAt = existing.UpdatedAt,
                    UpdatedBy = existing.UpdatedBy
                };
            }
        }
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        SelectedFile = e.File;
    }

    private async Task SaveSlider()
    {
        // Validation
        if (string.IsNullOrWhiteSpace(Slider.Title))
        {
            UploadError = "Vui lòng nhập tiêu đề!";
            return;
        }

        // Nếu là tạo mới hoặc chưa có ảnh, bắt buộc phải upload
        if (string.IsNullOrEmpty(Slider.Image) && SelectedFile == null)
        {
            UploadError = "Vui lòng chọn ảnh slider!";
            return;
        }

        var user = (await Auth.GetAuthenticationStateAsync()).User;
        string userName = user.Identity?.Name ?? "Anonymous";

        string? newImagePath = null;

        // ✅ Upload ảnh nếu có
        if (SelectedFile != null)
        {
            try
            {
                const long maxFileSize = 10_000_000; // 10MB
                if (SelectedFile.Size > maxFileSize)
                {
                    UploadError = "File quá lớn (≤10MB)";
                    return;
                }

                var ext = Path.GetExtension(SelectedFile.Name).ToLower();
                var allowed = new[] { ".jpg", ".jpeg", ".png", ".webp" };
                if (!allowed.Contains(ext))
                {
                    UploadError = "Chỉ cho phép JPG, PNG, WEBP";
                    return;
                }

                var fileName = Guid.NewGuid() + ext;
                var folder = Path.Combine(Env.WebRootPath, "images", "home");
                Directory.CreateDirectory(folder);

                var filePath = Path.Combine(folder, fileName);
                await using var fs = new FileStream(filePath, FileMode.Create);
                await SelectedFile.OpenReadStream(maxFileSize).CopyToAsync(fs);

                newImagePath = $"/images/home/{fileName}";
                UploadError = null;
            }
            catch (Exception ex)
            {
                UploadError = "Lỗi upload: " + ex.Message;
                return;
            }
        }

        if (IsEdit)
        {
            // Load lại entity từ DB và cập nhật từng field
            var existing = await Db.Sliders.FindAsync(Slider.SliderID);
            if (existing != null)
            {
                existing.Title = Slider.Title;
                existing.UpdatedAt = DateTime.Now;
                existing.UpdatedBy = userName;
                
                // Chỉ cập nhật ảnh nếu có ảnh mới
                if (newImagePath != null)
                {
                    existing.Image = newImagePath;
                }
                
                Db.Sliders.Update(existing);
            }
            else
            {
                Nav.NavigateTo("/admin/sliders");
                return;
            }
        }
        else
        {
            if (newImagePath != null)
            {
                Slider.Image = newImagePath;
            }
            Slider.CreatedAt = DateTime.Now;
            Slider.CreatedBy = userName;
            await Db.Sliders.AddAsync(Slider);
        }

        await Db.SaveChangesAsync();
        Nav.NavigateTo("/admin/sliders");
    }
}
